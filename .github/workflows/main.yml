name: ExtremeKRNL Nexus Build

on:
  workflow_dispatch:
    inputs:
      model:
        description: "Select Model (or 'all' for full distribution)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - beyond0lte
          - beyond1lte
          - beyond2lte
          - beyondx
          - d1
          - d1xks
          - d2s
          - d2x
          - d2xks
      ksu:
        description: "Include KernelSU?"
        required: true
        default: "y"
        type: choice
        options:
          - "y"
          - "n"

jobs:
  build:
    name: Build for ${{ matrix.model }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Don't stop other builds if one fails
      matrix:
        # This list includes all devices supported by your script
        model: [beyond0lte, beyond1lte, beyond2lte, beyondx, d1, d1xks, d2s, d2x, d2xks]
        # Logic to filter the matrix based on user input
        exclude:
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'beyond0lte' ? 'beyond0lte' : '') : '' }}
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'beyond1lte' ? 'beyond1lte' : '') : '' }}
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'beyond2lte' ? 'beyond2lte' : '') : '' }}
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'beyondx' ? 'beyondx' : '') : '' }}
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'd1' ? 'd1' : '') : '' }}
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'd1xks' ? 'd1xks' : '') : '' }}
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'd2s' ? 'd2s' : '') : '' }}
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'd2x' ? 'd2x' : '') : '' }}
          - model: ${{ github.event.inputs.model != 'all' ? (github.event.inputs.model != 'd2xks' ? 'd2xks' : '') : '' }}

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev \
          python3 cpio zip git clang llvm lld

      - name: Update Submodules
        run: |
          git submodule update --init --recursive
          git submodule update --remote

      - name: Build Kernel
        run: |
          chmod +x ./build.sh
          # Calling your script with the matrix variables
          ./build.sh --model ${{ matrix.model }} --ksu ${{ github.event.inputs.ksu }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ExtremeKRNL-${{ matrix.model }}-${{ github.run_id }}
          path: build/out/${{ matrix.model }}/*.zip
