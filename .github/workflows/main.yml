name: ExtremeKRNL Nexus Build

on:
  workflow_dispatch:
    inputs:
      model:
        description: "Select Model (or 'all' for full distribution)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - beyond0lte
          - beyond1lte
          - beyond2lte
          - beyondx
          - d1
          - d1xks
          - d2s
          - d2x
          - d2xks
      ksu:
        description: "Include KernelSU?"
        required: true
        default: "y"
        type: choice
        options:
          - "y"
          - "n"

jobs:
  # This job figures out exactly which devices to build
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [[ "${{ github.event.inputs.model }}" == "all" ]]; then
            # Full list of devices
            JSON='["beyond0lte", "beyond1lte", "beyond2lte", "beyondx", "d1", "d1xks", "d2s", "d2x", "d2xks"]'
          else
            # Just the one device selected
            JSON='["${{ github.event.inputs.model }}"]'
          fi
          echo "matrix={\"model\":$JSON}" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    runs-on: ubuntu-latest  # <-- The important line you mentioned!
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    name: Build ${{ matrix.model }}
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev \
          python3 cpio zip git clang llvm lld

      - name: Update Submodules
        run: |
          git submodule sync --recursive
          git submodule update --init --force --recursive --remote

      - name: Execute Build Script
        run: |
          chmod +x ./build.sh
          # Passing the model from the matrix and the KSU choice from input
          ./build.sh --model ${{ matrix.model }} --ksu ${{ github.event.inputs.ksu }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ExtremeKRNL-Nexus-${{ matrix.model }}
          path: build/out/${{ matrix.model }}/*.zip
